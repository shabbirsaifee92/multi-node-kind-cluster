#!/bin/bash
set -eou pipefail

echo -e "\n*******************************************************************************************************************"
echo -e "Installing helm"
echo -e "*******************************************************************************************************************"
brew install helm

echo -e "\n*******************************************************************************************************************"
echo -e "Adding istio helm repo"
echo -e "*******************************************************************************************************************"
helm repo add istio https://istio-release.storage.googleapis.com/charts

echo -e "\n*******************************************************************************************************************"
echo -e "Installing istio base CRDs"
echo -e "*******************************************************************************************************************"
helm install istio-base istio/base -n istio-system --create-namespace

echo -e "\n*******************************************************************************************************************"
echo -e "Installing istiod (control plane)"
echo -e "*******************************************************************************************************************"
helm install istiod istio/istiod -n istio-system --wait

echo -e "\n*******************************************************************************************************************"
echo -e "Labelling default namespace to autoinject istio-proxy sidecar"
echo -e "*******************************************************************************************************************"
kubectl label ns default istio-injection=enabled --overwrite

echo -e "\n*******************************************************************************************************************"
echo -e "Waiting for istio to be ready"
echo -e "*******************************************************************************************************************"
kubectl wait pods --for=condition=Ready -l app=istiod -n istio-system

echo -e "\nIstio service mesh is ready"
